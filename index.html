<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR –ö–æ—Ç–µ–Ω–æ–∫ - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            overflow: hidden;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            font-size: 14px;
            border: 2px solid rgba(155, 89, 182, 0.5);
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }
        
        .btn {
            padding: 15px 25px;
            margin: 8px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 100%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            font-size: 18px;
            pointer-events: auto;
            max-width: 320px;
            border: 2px solid #9B59B6;
        }
        
        #scanner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #9B59B6;
            border-radius: 20px;
            opacity: 0.7;
            animation: scanner-pulse 2s infinite;
            pointer-events: none;
            z-index: 500;
            display: none;
        }
        
        @keyframes scanner-pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 0.3; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
        }
        
        .surface-indicator {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 2px solid #00FF88;
            border-radius: 50%;
            background: rgba(0, 255, 136, 0.2);
            animation: surface-found 1s infinite;
            pointer-events: none;
            z-index: 600;
        }
        
        @keyframes surface-found {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        .glow {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }
        
        @media (max-width: 600px) {
            .btn {
                padding: 12px 18px;
                font-size: 14px;
                margin: 5px;
            }
            
            #info, #controls {
                margin: 10px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="scanner"></div>
    
    <div id="ui">
        <div id="status">
            <div style="font-size: 48px; margin-bottom: 10px;">üîç</div>
            <p id="status-text">–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebXR...</p>
            <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                <div id="device-info">–û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...</div>
            </div>
        </div>
        
        <div id="info" style="display: none;">
            <h3 class="glow">üéØ AR –ö–æ—Ç–µ–Ω–æ–∫ —Å –∞–≤—Ç–æ–ø–æ–∏—Å–∫–æ–º</h3>
            <p id="instructions"><strong>–ú–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º –ø–æ –∫–æ–º–Ω–∞—Ç–µ</strong></p>
            <p>‚Ä¢ <span id="surface-status">–ò—â–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏...</span></p>
            <p>‚Ä¢ –ö–æ—Ç—è—Ç–∞: <span id="kitten-count">0</span></p>
            <p>‚Ä¢ <span id="performance">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: OK</span></p>
        </div>
        
        <div id="controls" style="display: none;">
            <button class="btn" id="ar-button" onclick="startAR()">üöÄ –ù–∞—á–∞—Ç—å AR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <button class="btn" onclick="placeKitten()" disabled id="place-btn">üê± –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∫–æ—Ç–µ–Ω–∫–∞</button>
            <button class="btn" onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <button class="btn" onclick="toggleAutoPlace()">üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º</button>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let scene, camera, renderer, xrSession;
        let kittens = [];
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let reticle;
        let isAutoPlaceMode = false;
        let lastPlaceTime = 0;
        let surfaceFound = false;
        
        // UI —ç–ª–µ–º–µ–Ω—Ç—ã
        const statusDiv = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const deviceInfo = document.getElementById('device-info');
        const infoDiv = document.getElementById('info');
        const controlsDiv = document.getElementById('controls');
        const scanner = document.getElementById('scanner');
        const arButton = document.getElementById('ar-button');
        const placeButton = document.getElementById('place-btn');
        const surfaceStatus = document.getElementById('surface-status');
        const kittenCount = document.getElementById('kitten-count');
        const instructions = document.getElementById('instructions');
        const performance = document.getElementById('performance');
        
        function updateStatus(message) {
            statusText.textContent = message;
            console.log('Status:', message);
        }
        
        function updateSurfaceStatus(message) {
            surfaceStatus.textContent = message;
        }
        
        function updateInstructions(message) {
            instructions.innerHTML = message;
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function detectDevice() {
            const userAgent = navigator.userAgent;
            let device = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
            
            if (/Android/i.test(userAgent)) {
                if (/Chrome/i.test(userAgent)) {
                    device = 'Android Chrome ‚úÖ';
                } else {
                    device = 'Android (–Ω–µ Chrome) ‚ö†Ô∏è';
                }
            } else if (/iPhone|iPad/i.test(userAgent)) {
                if (/Safari/i.test(userAgent)) {
                    device = 'iOS Safari ‚úÖ';
                } else {
                    device = 'iOS (–Ω–µ Safari) ‚ö†Ô∏è';
                }
            } else {
                device = 'Desktop/Other ‚ùå';
            }
            
            deviceInfo.textContent = device;
            return device;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                updateStatus('–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ...');
                const device = detectDevice();
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                updateStatus('–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebXR...');
                
                if ('xr' in navigator) {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (supported) {
                        updateStatus('‚úÖ WebXR AR –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è!');
                        initThree();
                        statusDiv.style.display = 'none';
                        infoDiv.style.display = 'block';
                        controlsDiv.style.display = 'block';
                    } else {
                        updateStatus('‚ùå WebXR AR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                        fallbackToSimpleAR();
                    }
                } else {
                    updateStatus('‚ùå WebXR –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    fallbackToSimpleAR();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                updateStatus('–û—à–∏–±–∫–∞: ' + error.message);
                fallbackToSimpleAR();
            }
        }
        
        function initThree() {
            // –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            
            // –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            // –†–µ–Ω–¥–µ—Ä–µ—Ä —Å WebXR
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            
            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            setupLighting();
            
            // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
            createSurfaceReticle();
            
            // –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            renderer.setAnimationLoop(render);
            
            updateSurfaceStatus('–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é');
            updateInstructions('<strong>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å AR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"</strong>');
        }
        
        function setupLighting() {
            // –û–∫—Ä—É–∂–∞—é—â–∏–π —Å–≤–µ—Ç
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            
            // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–≤–µ—Ç —Å —Ç–µ–Ω—è–º–∏
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(2, 4, 2);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.near = 0.1;
            directionalLight.shadow.camera.far = 10;
            directionalLight.shadow.camera.left = -2;
            directionalLight.shadow.camera.right = 2;
            directionalLight.shadow.camera.top = 2;
            directionalLight.shadow.camera.bottom = -2;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å–≤–µ—Ç –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è
            const pointLight = new THREE.PointLight(0x9B59B6, 0.5, 5);
            pointLight.position.set(0, 2, 0);
            scene.add(pointLight);
        }
        
        function createSurfaceReticle() {
            // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏
            const geometry = new THREE.RingGeometry(0.1, 0.12, 32).rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00FF88,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            
            reticle = new THREE.Mesh(geometry, material);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç
            reticle.userData.pulseTime = 0;
        }
        
        async function startAR() {
            try {
                updateSurfaceStatus('–ó–∞–ø—É—Å–∫ AR —Å–µ—Å—Å–∏–∏...');
                arButton.disabled = true;
                scanner.style.display = 'block';
                
                // –ó–∞–ø—Ä–æ—Å AR —Å–µ—Å—Å–∏–∏ —Å hit-testing
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.getElementById('ui') }
                });
                
                renderer.xr.setSession(xrSession);
                
                // –°–æ–±—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏
                xrSession.addEventListener('end', onSessionEnd);
                
                updateSurfaceStatus('AR –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –ò—â–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏...');
                updateInstructions('<strong>–ú–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º</strong><br>–ù–∞–≤–æ–¥–∏—Ç–µ –Ω–∞ –ø–æ–ª, —Å—Ç–æ–ª, —Å—Ç–µ–Ω—ã');
                
                arButton.textContent = 'üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å AR';
                arButton.onclick = endAR;
                arButton.disabled = false;
                
                performance.textContent = '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: AR –∞–∫—Ç–∏–≤–µ–Ω';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ AR:', error);
                updateSurfaceStatus('–û—à–∏–±–∫–∞ AR: ' + error.message);
                arButton.disabled = false;
                scanner.style.display = 'none';
                fallbackToSimpleAR();
            }
        }
        
        function endAR() {
            if (xrSession) {
                xrSession.end();
            }
        }
        
        function onSessionEnd() {
            xrSession = null;
            hitTestSource = null;
            hitTestSourceRequested = false;
            surfaceFound = false;
            
            arButton.textContent = 'üöÄ –ù–∞—á–∞—Ç—å AR-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
            arButton.onclick = startAR;
            arButton.disabled = false;
            placeButton.disabled = true;
            
            scanner.style.display = 'none';
            reticle.visible = false;
            
            updateSurfaceStatus('AR –∑–∞–≤–µ—Ä—à–µ–Ω');
            updateInstructions('<strong>AR —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</strong>');
            performance.textContent = '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: OK';
        }
        
        function placeKitten() {
            if (!xrSession || !reticle.visible) {
                updateSurfaceStatus('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å!');
                return;
            }
            
            createKittenAtReticle();
        }
        
        function createKittenAtReticle() {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é reticle
            const position = new THREE.Vector3();
            const quaternion = new THREE.Quaternion();
            const scale = new THREE.Vector3();
            
            reticle.matrix.decompose(position, quaternion, scale);
            
            // –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É –¥–ª—è –∫–æ—Ç–µ–Ω–∫–∞
            const kittenGroup = new THREE.Group();
            kittenGroup.position.copy(position);
            kittenGroup.quaternion.copy(quaternion);
            
            // –ü–æ–¥–Ω–∏–º–∞–µ–º –∫–æ—Ç–µ–Ω–∫–∞ –Ω–∞–¥ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å—é
            kittenGroup.position.y += 0.15;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ç–µ–Ω–∫–∞
            const loader = new THREE.TextureLoader();
            loader.load('kitten.jpg', 
                function(texture) {
                    console.log('‚úÖ –ö–æ—Ç–µ–Ω–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å!');
                    createKittenMesh(kittenGroup, texture);
                },
                undefined,
                function(error) {
                    console.log('–°–æ–∑–¥–∞–µ–º fallback –∫–æ—Ç–µ–Ω–∫–∞');
                    createKittenMesh(kittenGroup, null);
                }
            );
            
            scene.add(kittenGroup);
            kittens.push(kittenGroup);
            updateKittenCount();
            
            updateSurfaceStatus(`–ö–æ—Ç–µ–Ω–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω! –í—Å–µ–≥–æ: ${kittens.length}`);
            
            // –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            showPlacementEffect(position);
        }
        
        function createKittenMesh(group, texture) {
            // –û—Å–Ω–æ–≤–Ω–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç—å –∫–æ—Ç–µ–Ω–∫–∞
            const geometry = new THREE.PlaneGeometry(0.3, 0.3);
            
            let material;
            if (texture) {
                material = new THREE.MeshLambertMaterial({ 
                    map: texture,
                    transparent: true,
                    side: THREE.DoubleSide
                });
            } else {
                material = new THREE.MeshLambertMaterial({ 
                    color: 0x9B59B6,
                    transparent: true,
                    opacity: 0.8
                });
            }
            
            const kittenMesh = new THREE.Mesh(geometry, material);
            kittenMesh.castShadow = true;
            kittenMesh.receiveShadow = true;
            group.add(kittenMesh);
            
            // –ú–∞–≥–∏—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            addKittenEffects(group);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            group.scale.set(0, 0, 0);
            animateKittenAppearance(group);
        }
        
        function addKittenEffects(group) {
            // –ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞
            const frameGeometry = new THREE.RingGeometry(0.16, 0.18, 32);
            const frameMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xFFD700,
                transparent: true,
                opacity: 0.8
            });
            const frame = new THREE.Mesh(frameGeometry, frameMaterial);
            frame.position.z = -0.01;
            group.add(frame);
            
            // –ú–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
            const glowGeometry = new THREE.RingGeometry(0.19, 0.22, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x9B59B6,
                transparent: true,
                opacity: 0.4
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            glow.position.z = -0.02;
            group.add(glow);
            
            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            group.userData.rotationSpeed = 0.005;
            group.userData.glowPulse = 0;
        }
        
        function animateKittenAppearance(group) {
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            const startTime = Date.now();
            const duration = 1000;
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing —Ñ—É–Ω–∫—Ü–∏—è
                const easeOut = 1 - Math.pow(1 - progress, 3);
                
                group.scale.setScalar(easeOut);
                group.rotation.y = (1 - progress) * Math.PI * 2;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            animate();
        }
        
        function showPlacementEffect(position) {
            // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            const effectElement = document.createElement('div');
            effectElement.className = 'surface-indicator';
            effectElement.style.left = '50%';
            effectElement.style.top = '50%';
            effectElement.style.transform = 'translate(-50%, -50%)';
            document.body.appendChild(effectElement);
            
            setTimeout(() => {
                document.body.removeChild(effectElement);
            }, 1000);
        }
        
        function toggleAutoPlace() {
            isAutoPlaceMode = !isAutoPlaceMode;
            updateSurfaceStatus(isAutoPlaceMode ? '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º –í–ö–õ' : '–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º');
            
            const btn = event.target;
            btn.textContent = isAutoPlaceMode ? '‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ' : 'üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º';
        }
        
        function clearAll() {
            kittens.forEach(kitten => {
                scene.remove(kitten);
            });
            kittens = [];
            updateKittenCount();
            updateSurfaceStatus('–í—Å–µ –∫–æ—Ç—è—Ç–∞ —É–¥–∞–ª–µ–Ω—ã');
        }
        
        function updateKittenCount() {
            kittenCount.textContent = kittens.length;
        }
        
        function render(timestamp, frame) {
            if (frame && xrSession) {
                // Hit testing –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π
                if (!hitTestSourceRequested) {
                    xrSession.requestReferenceSpace('viewer').then(function(referenceSpace) {
                        xrSession.requestHitTestSource({ space: referenceSpace }).then(function(source) {
                            hitTestSource = source;
                            hitTestSourceRequested = true;
                            updateSurfaceStatus('–°–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π –∞–∫—Ç–∏–≤–Ω–∞');
                        });
                    });
                }
                
                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    
                    if (hitTestResults.length) {
                        if (!surfaceFound) {
                            surfaceFound = true;
                            updateSurfaceStatus('‚úÖ –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–∞!');
                            updateInstructions('<strong>–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞!</strong><br>–ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –∫–æ—Ç–µ–Ω–∫–∞"');
                            placeButton.disabled = false;
                        }
                        
                        const hit = hitTestResults[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(renderer.xr.getReferenceSpace()).transform.matrix);
                        
                        // –ü—É–ª—å—Å–∞—Ü–∏—è reticle
                        reticle.userData.pulseTime += 0.1;
                        const scale = 1 + Math.sin(reticle.userData.pulseTime) * 0.2;
                        reticle.scale.setScalar(scale);
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                        if (isAutoPlaceMode && timestamp - lastPlaceTime > 3000) { // –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
                            createKittenAtReticle();
                            lastPlaceTime = timestamp;
                        }
                        
                    } else {
                        if (surfaceFound) {
                            surfaceFound = false;
                            updateSurfaceStatus('–ò—â–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏...');
                            updateInstructions('<strong>–í–æ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º</strong><br>–ù–∞–≤–æ–¥–∏—Ç–µ –Ω–∞ –ø–æ–ª, —Å—Ç–æ–ª, —Å—Ç–µ–Ω—ã');
                            placeButton.disabled = true;
                        }
                        reticle.visible = false;
                    }
                }
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ—Ç—è—Ç
            kittens.forEach(kitten => {
                if (kitten.userData.rotationSpeed) {
                    kitten.rotation.y += kitten.userData.rotationSpeed;
                }
                
                // –ü—É–ª—å—Å–∞—Ü–∏—è —Å–≤–µ—á–µ–Ω–∏—è
                kitten.userData.glowPulse += 0.05;
                const glowChild = kitten.children[2]; // glow —ç–ª–µ–º–µ–Ω—Ç
                if (glowChild) {
                    glowChild.material.opacity = 0.2 + Math.sin(kitten.userData.glowPulse) * 0.2;
                }
            });
            
            renderer.render(scene, camera);
        }
        
        function fallbackToSimpleAR() {
            statusDiv.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                <p>WebXR –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</p>
                <p style="font-size: 14px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—É—é AR –≤–µ—Ä—Å–∏—é</p>
                <button class="btn" onclick="window.location.reload()" style="margin-top: 15px;">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
            `;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞
        window.addEventListener('resize', function() {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
        
        // –ó–∞–ø—É—Å–∫
        window.addEventListener('load', init);
        
        console.log('üåü WebXR AR —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω!');
    </script>
</body>
</html>
