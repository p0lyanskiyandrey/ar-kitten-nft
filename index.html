<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>–ù–∞—Å—Ç–æ—è—â–∏–π Motion AR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            background: black;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        #crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            z-index: 4;
            cursor: pointer;
            border: 2px solid white;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
        }
        
        .point {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }
        
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 5;
            font-family: monospace;
            max-width: 200px;
        }
        
        #calibration {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 6;
            display: none;
        }
        
        .btn {
            padding: 12px 20px;
            background: #9B59B6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin: 10px;
        }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline muted></video>
    
    <div id="crosshair">
        <div class="point"></div>
    </div>
    
    <div id="status">
        <div>üì± Motion: <span id="motionStatus">–û—Ç–∫–ª—é—á–µ–Ω</span></div>
        <div>üß≠ Heading: <span id="heading">0¬∞</span></div>
        <div>üìê Tilt: <span id="tilt">0¬∞</span></div>
        <div>üìç Pos: X:<span id="posX">0</span> Z:<span id="posZ">0</span></div>
        <div>üê± –ö–æ—Ç—è—Ç: <span id="kittenCount">0</span></div>
        <div>üìè –†–∞—Å—Å—Ç: <span id="distance">-</span></div>
    </div>
    
    <div id="calibration">
        <h3>üìê –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞</h3>
        <p>–î–µ—Ä–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –ø—Ä—è–º–æ</p>
        <button class="btn" onclick="calibrate()">‚úÖ –ö–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn" onclick="skipCalibration()">‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let video, scene, camera, renderer;
        let kittens = [];
        
        // –†–µ–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–º–Ω–∞—Ç–µ
        let userPosition = {
            x: 0,
            y: 1.7,
            z: 0
        };
        
        // –û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        let deviceOrientation = {
            alpha: 0,  // –ö–æ–º–ø–∞—Å (0-360¬∞)
            beta: 0,   // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥ (-180 –¥–æ 180¬∞)
            gamma: 0   // –ù–∞–∫–ª–æ–Ω –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ (-90 –¥–æ 90¬∞)
        };
        
        // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞
        let calibration = {
            alpha: 0,
            beta: 0,
            gamma: 0,
            isCalibrated: false
        };
        
        // –ü—Ä–µ–¥—ã–¥—É—â–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–≤–∏–∂–µ–Ω–∏—è
        let previousOrientation = {
            alpha: 0,
            beta: 0,
            gamma: 0
        };
        
        let motionEnabled = false;
        let permissionGranted = false;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            try {
                video = document.getElementById('video');
                await startCamera();
                
                init3D();
                await requestMotionPermission();
                setupEvents();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
                document.getElementById('calibration').style.display = 'block';
                
                animate();
                console.log('Motion AR –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError(error.message);
            }
        }
        
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
            } catch (error) {
                throw new Error('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        }
        
        async function requestMotionPermission() {
            // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è iOS 13+
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        permissionGranted = true;
                        document.getElementById('motionStatus').textContent = '–†–∞–∑—Ä–µ—à–µ–Ω';
                    } else {
                        document.getElementById('motionStatus').textContent = '–û—Ç–∫–ª–æ–Ω–µ–Ω';
                    }
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:', error);
                    document.getElementById('motionStatus').textContent = '–û—à–∏–±–∫–∞';
                }
            } else {
                // Android –∏–ª–∏ —Å—Ç–∞—Ä—ã–µ iOS
                permissionGranted = true;
                document.getElementById('motionStatus').textContent = '–ê–≤—Ç–æ';
            }
        }
        
        function init3D() {
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.01,
                1000
            );
            
            updateCameraFromMotion();
            
            renderer = new THREE.WebGLRenderer({ 
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0';
            renderer.domElement.style.left = '0';
            renderer.domElement.style.zIndex = '2';
            renderer.domElement.style.pointerEvents = 'none';
            document.body.appendChild(renderer.domElement);
            
            setupLighting();
        }
        
        function setupLighting() {
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
        }
        
        function setupEvents() {
            // –î–∞—Ç—á–∏–∫ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            window.addEventListener('deviceorientation', function(event) {
                if (permissionGranted && motionEnabled) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const rawAlpha = event.alpha || 0;
                    const rawBeta = event.beta || 0;
                    const rawGamma = event.gamma || 0;
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞–ª–∏–±—Ä–æ–≤–∫—É
                    deviceOrientation.alpha = rawAlpha - calibration.alpha;
                    deviceOrientation.beta = rawBeta - calibration.beta;
                    deviceOrientation.gamma = rawGamma - calibration.gamma;
                    
                    // –†–∞—Å—á–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
                    calculateMovementFromOrientation();
                    
                    updateCameraFromMotion();
                    updateStatus();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–∞–¥—Ä–∞
                    previousOrientation.alpha = deviceOrientation.alpha;
                    previousOrientation.beta = deviceOrientation.beta;
                    previousOrientation.gamma = deviceOrientation.gamma;
                }
            }, true);
            
            // –ö–ª–∏–∫ –ø–æ —Ç–æ—á–∫–µ
            document.getElementById('crosshair').addEventListener('click', function(event) {
                event.stopPropagation();
                placeKitten();
            });
            
            document.getElementById('crosshair').addEventListener('touchstart', function(event) {
                event.preventDefault();
                event.stopPropagation();
                placeKitten();
            }, { passive: false });
        }
        
        function calculateMovementFromOrientation() {
            if (!calibration.isCalibrated) return;
            
            // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–≥–ª–æ–≤
            const deltaAlpha = deviceOrientation.alpha - previousOrientation.alpha;
            const deltaBeta = deviceOrientation.beta - previousOrientation.beta;
            
            // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è
            const movementSensitivity = 0.01;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —É–≥–ª–æ–≤ –≤ –¥–≤–∏–∂–µ–Ω–∏–µ
            if (Math.abs(deltaAlpha) > 5) { // –ü–æ–≤–æ—Ä–æ—Ç –≥–æ–ª–æ–≤—ã –≤–ª–µ–≤–æ-–≤–ø—Ä–∞–≤–æ
                const moveAmount = deltaAlpha * movementSensitivity;
                userPosition.x += Math.sin(deviceOrientation.alpha * Math.PI / 180) * moveAmount;
                userPosition.z += Math.cos(deviceOrientation.alpha * Math.PI / 180) * moveAmount;
            }
            
            if (Math.abs(deltaBeta) > 5) { // –ù–∞–∫–ª–æ–Ω –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥
                const moveAmount = deltaBeta * movementSensitivity;
                userPosition.z += moveAmount;
            }
        }
        
        function calibrate() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –∫–∞–∫ –±–∞–∑–æ–≤—É—é
            calibration.alpha = deviceOrientation.alpha;
            calibration.beta = deviceOrientation.beta;
            calibration.gamma = deviceOrientation.gamma;
            calibration.isCalibrated = true;
            
            motionEnabled = true;
            document.getElementById('motionStatus').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
            document.getElementById('calibration').style.display = 'none';
            
            console.log('–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        }
        
        function skipCalibration() {
            calibration.isCalibrated = true;
            motionEnabled = true;
            document.getElementById('motionStatus').textContent = '–ë–µ–∑ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏';
            document.getElementById('calibration').style.display = 'none';
        }
        
        function placeKitten() {
            // –†–∞–∑–º–µ—â–∞–µ–º –∫–æ—Ç–µ–Ω–∫–∞ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 1.5 –º–µ—Ç—Ä–∞ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –≤–∑–≥–ª—è–¥–∞
            const distance = 1.5;
            const direction = new THREE.Vector3(0, 0, -distance);
            
            // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –≥–æ–ª–æ–≤—ã
            const yawRad = deviceOrientation.alpha * Math.PI / 180;
            direction.applyAxisAngle(new THREE.Vector3(0, 1, 0), yawRad);
            
            const kittenPosition = {
                x: userPosition.x + direction.x,
                y: userPosition.y,
                z: userPosition.z + direction.z
            };
            
            createKittenAt(kittenPosition);
            console.log(`–ö–æ—Ç–µ–Ω–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω: X:${kittenPosition.x.toFixed(2)} Y:${kittenPosition.y.toFixed(2)} Z:${kittenPosition.z.toFixed(2)}`);
        }
        
        function createKittenAt(worldPosition) {
            const kittenGroup = new THREE.Group();
            
            // –ê–ë–°–û–õ–Æ–¢–ù–û –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ø–æ–∑–∏—Ü–∏—è –≤ –º–∏—Ä–µ
            kittenGroup.position.set(worldPosition.x, worldPosition.y, worldPosition.z);
            
            const loader = new THREE.TextureLoader();
            loader.load('kitten.jpg', 
                function(texture) {
                    createKittenMesh(kittenGroup, texture);
                },
                undefined,
                function(error) {
                    createKittenMesh(kittenGroup, null);
                }
            );
            
            scene.add(kittenGroup);
            kittens.push(kittenGroup);
            
            updateStatus();
        }
        
        function createKittenMesh(group, texture) {
            const size = 0.6; // 60 —Å–º
            const geometry = new THREE.PlaneGeometry(size, size);
            
            let material;
            if (texture) {
                material = new THREE.MeshLambertMaterial({ 
                    map: texture,
                    transparent: false,
                    side: THREE.DoubleSide
                });
            } else {
                material = new THREE.MeshLambertMaterial({ 
                    color: 0x9B59B6
                });
            }
            
            const kittenMesh = new THREE.Mesh(geometry, material);
            group.add(kittenMesh);
            
            // –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–º–∫–∞
            const frameGeometry = new THREE.RingGeometry(size/2 + 0.02, size/2 + 0.04, 32);
            const frameMaterial = new THREE.MeshLambertMaterial({ 
                color: 0xFFD700
            });
            const frame = new THREE.Mesh(frameGeometry, frameMaterial);
            frame.position.z = -0.01;
            group.add(frame);
            
            // –ö–æ—Ç–µ–Ω–æ–∫ –ù–ï –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è - –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º!
            console.log('‚úÖ –ö–æ—Ç–µ–Ω–æ–∫ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –≤ –º–∏—Ä–µ');
        }
        
        function updateCameraFromMotion() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã
            camera.position.set(userPosition.x, userPosition.y, userPosition.z);
            
            // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É —Å–æ–≥–ª–∞—Å–Ω–æ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            if (motionEnabled) {
                const yawRad = deviceOrientation.alpha * Math.PI / 180;
                const pitchRad = deviceOrientation.beta * Math.PI / 180;
                const rollRad = deviceOrientation.gamma * Math.PI / 180;
                
                camera.rotation.set(pitchRad, yawRad, rollRad);
            }
        }
        
        function updateStatus() {
            document.getElementById('heading').textContent = Math.round(deviceOrientation.alpha) + '¬∞';
            document.getElementById('tilt').textContent = Math.round(deviceOrientation.beta) + '¬∞';
            document.getElementById('posX').textContent = userPosition.x.toFixed(2);
            document.getElementById('posZ').textContent = userPosition.z.toFixed(2);
            document.getElementById('kittenCount').textContent = kittens.length;
            
            if (kittens.length > 0) {
                const distance = camera.position.distanceTo(kittens[0].position);
                document.getElementById('distance').textContent = distance.toFixed(2) + '–º';
            }
        }
        
        function showError(message) {
            document.body.innerHTML = `
                <div style="
                    color: white; 
                    padding: 20px; 
                    text-align: center; 
                    font-family: Arial; 
                    background: black;
                    height: 100vh;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                ">
                    <h2>–û—à–∏–±–∫–∞</h2>
                    <p>${message}</p>
                    <button onclick="location.reload()" style="
                        padding: 15px 30px; 
                        font-size: 16px; 
                        background: #9B59B6; 
                        color: white; 
                        border: none; 
                        border-radius: 10px; 
                        cursor: pointer;
                    ">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        
        window.addEventListener('resize', function() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        window.addEventListener('load', init);
        
        console.log('üéØ Motion AR —Å —Ä–µ–∞–ª—å–Ω—ã–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –¥–≤–∏–∂–µ–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω');
    </script>
</body>
</html>
